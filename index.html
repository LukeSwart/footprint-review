<!DOCTYPE html>
<html lang="en">
    <meta charset=utf8 />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <head>
        <title>
            Footprint Compare - San Juan County WA
        </title>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />

        <style>
         html, body { width: 100%; height:100%; margin:0;}
         .map { width:49.5%; height:80%;}
         .leaflet-control-mapId {
             box-shadow: 0 1px 5px rgba(0,0,0,0.4);
             background: #fff;
             border-radius: 5px;
             width: 36px;
             height: 36px;
             text-align: center;
         }
         .leaflet-control-mapId-title {
             line-height: 8px;
         }
         #map1 { float:left;}
         #map2 { float:right;}
         #footer {
             text-align: center;
             line-height: 18px;
         }
        </style>
    </head>

    <body>
        <div id="map1" class="map"></div>
        <div id="map2" class="map"></div>
        <div id="footer">
            <h3>Which building footprint is better?</h3>
            <p>Choose Map 1 if footprints are identical. Skip if the building is obscured in the photo. Flag if neither footprint is accurate.</p>
            <button type="button" name="map1" onclick="submitVote('map1')">Map 1</button>
            <button type="button" name="skip" onclick="submitVote('skip')">Skip</button>
            <button type="button" name="flag" onclick="submitVote('flag')">Flag</button>
            <button type="button" name="map2" onclick="submitVote('map2')">Map 2</button>
            <p><a target="_blank" href="readme.html">What is this?</a></p>
        </div>
        <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
        <script src="//cdn.jsdelivr.net/leaflet.esri/1.0.3/esri-leaflet.js"></script>

        <script type="text/javascript">
         var currentId;

         var mapOptions = {
             minZoom: 16,
             maxZoom: 19,
             dragging: false,
             keyboard: false
         }
         var map1 = L.map('map1', mapOptions);
         var map2 = L.map('map2', mapOptions);

         var layer1 = L.esri.tiledMapLayer({
             url: 'https://sjcgis.org/arcgis/rest/services/Basemaps/Aerials_2013_WM/MapServer',
             maxZoom: 19
         });
         layer1.addTo(map1);
         L.esri.tiledMapLayer({
             url: 'https://sjcgis.org/arcgis/rest/services/Basemaps/Aerials_2013_WM/MapServer',
             maxZoom: 19
         }).addTo(map2);

         var locationLayer = L.esri.Services.featureLayerService({
             url: 'http://services.arcgis.com/PNkCg7xWnaf90qde/arcgis/rest/services/Footprint_Compare/FeatureServer/0'
         });
         var sjcFootprintLayer = L.esri.featureLayer({
             url: 'http://services.arcgis.com/PNkCg7xWnaf90qde/arcgis/rest/services/Footprint_Compare/FeatureServer/1'
         }).addTo(map1);
         var pictFootprintLayer = L.esri.featureLayer({
             url: 'http://services.arcgis.com/PNkCg7xWnaf90qde/arcgis/rest/services/Footprint_Compare/FeatureServer/2'
         }).addTo(map2);

         var query = locationLayer.query();

         var mapIdControl = L.Control.extend({
             options: {
                 position: 'topright',
                 mapId: '1'
             },

             initialize: function(options) {
                 L.setOptions(this, options);
             },

             onAdd: function(map) {
                 var container = L.DomUtil.create('div', 'leaflet-control-mapId');
                 var id = L.DomUtil.create('h2', 'leaflet-control-mapId-title', container);
                 id.innerText = this.options.mapId;
                 return container;
             },

             onRemove: function(map) {
                 return;
             }
         });

         map1.addControl(new mapIdControl({ mapId: 1 }));
         map2.addControl(new mapIdControl({ mapId: 2 }));

         /**
            * This function finds a random compare location and passes the
            footprint IDs to the drawFootprints function.
            * @param {min} minimum inclusive feature id for random function
            * @param {max} maximum inclusive feature id for random function
            * @returns {}
         */
         function getRandomFootprint(min, max) {
             currentId = Math.floor(Math.random() * (max- min + 1)) + min;
             query.where("OBJECTID = " + currentId);
             query.run(function(err, fc, res) {
                 if (err) throw new Error(err.message);
                 var loc = fc.features[0].geometry.coordinates;
                 var sjcId = fc.features[0].properties.SJC_Footprints_OBJECTID;
                 var pictId = fc.features[0].properties.PICT_Footprints_OBJECTID;
                 drawFootprints(loc, sjcId, pictId);
             });
         };

         /**
            * This function modifies the `where` parameter on the footprint
            layers and centers the maps on the location
            * @param {loc} coordinates to center the maps
            * @param {sjcId} feature id for the SJC footprints
            * @param {pictId} feature id for the Pictometry footprints
            * @returns {}
          */
         function drawFootprints(loc, sjcId, pictId) {
             sjcFootprintLayer.setWhere("OBJECTID = " + sjcId);
             pictFootprintLayer.setWhere("OBJECTID = " + pictId);
             map1.setView([loc[1], loc[0]], 19);
             map2.setView([loc[1], loc[0]], 19);
         }

         /**
            * This function adds one to the appropriate field in the
            locationLayer based on the button clicked. Afterwards it
            automatically requests a new location.
            * @param {button} id of the button clicked
            * @returns {}
          */
         function submitVote(button) {
             query.where("OBJECTID = " + currentId);
             query.run(function(err, fc, res) {
                 if (err) throw new Error(err.message);
                 var f = fc.features[0];
                 switch (button) {
                     case 'map1':
                         f.properties.SJC_VOTES += 1;
                         break;
                     case 'map2':
                         f.properties.PICT_VOTES += 1;
                         break;
                     case 'skip':
                         f.properties.SKIPS += 1;
                         break;
                     case 'flag':
                         f.properties.FLAGS += 1;
                         break;
                     default:
                         console.log('No votes');
                         break;
                 }
                 locationLayer.updateFeature(f, function(err, res) {
                     if (err) throw new Error(err.message);
                     if (!res.success == true) {
                         throw new Error('Update failed')
                     }
                     getRandomFootprint(1,18772);
                 });

             });
         }
         getRandomFootprint(1,18772);
        </script>
    </body>
</html>
